name: VPS-Ubuntu-Root-24-04-Infinite

on:
  workflow_dispatch:

env:
  TZ: UTC

jobs:
  boot-and-root:
    runs-on: ubuntu-24.04
    steps:
      - name: Update system
        run: |
          sudo apt-get update -y
          sudo apt-get dist-upgrade -y

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
                           --hostname="gh-root-${{ github.run_id }}"

      - name: Create user 'vps@35' with random password
        id: user
        run: |
          PASS=$(openssl rand -base64 32)
          sudo useradd -m -s /bin/bash vps@35
          echo "vps@35:$PASS" | sudo chpasswd
          sudo usermod -aG sudo vps@35
          echo "vps@35 ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/99-vps
          sudo usermod -L vps@35
          echo "USER=vps@35" >> $GITHUB_OUTPUT
          echo "PASSWORD=$PASS" >> $GITHUB_OUTPUT
          echo "::notice::User: vps@35  |  Password: $PASS"

      - name: Add your SSH public key
        run: |
          sudo mkdir -p /home/vps@35/.ssh
          echo "${{ secrets.VPS_PUBLIC_KEY }}" | sudo tee /home/vps@35/.ssh/authorized_keys
          sudo chown -R vps@35:vps@35 /home/vps@35/.ssh
          sudo chmod 700 /home/vps@35/.ssh
          sudo chmod 600 /home/vps@35/.ssh/authorized_keys

      - name: Harden SSH (key-only)
        run: |
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart || true

      - name: Show credentials & Tailscale IP
        id: ts
        run: |
          IP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_OUTPUT
          echo "::notice::Tailscale IP: $IP"

      - name: Keep alive (infinite)
        run: |
          echo "Runner kept alive. Cancel workflow to stop."
          cat /dev/zero > /dev/null

      - name: Cleanup
        if: always()
        run: sudo tailscale down || true
