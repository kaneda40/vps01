name: VPS-Ubuntu-Root-24-04-Open

on:
  workflow_dispatch:

env:
  TZ: UTC

jobs:
  open-vps:
    runs-on: ubuntu-24.04
    steps:
      - name: Update system
        run: |
          sudo apt-get update -y
          sudo apt-get dist-upgrade -y

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
                           --hostname="gh-open-${{ github.run_id }}"

      - name: Create user 'vps@35' with static password
        run: |
          sudo useradd -m -s /bin/bash vps@35
          echo "vps@35:vps@35" | sudo chpasswd
          sudo usermod -aG sudo vps@35

      - name: Allow sudo without password for ALL users
        run: |
          echo "%sudo ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/99-all-sudo
          echo "ALL ALL=(ALL) NOPASSWD:ALL"   | sudo tee -a /etc/sudoers.d/99-all-sudo

      - name: Enable root login with static password
        run: |
          echo "root:vps@35" | sudo chpasswd
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart || true

      - name: Show Tailscale IP
        id: ts
        run: |
          IP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_OUTPUT
          echo "::notice::Tailscale IP: $IP"

      - name: Keep alive (infinite)
        run: |
          echo "Runner kept alive. Cancel workflow to stop."
          cat /dev/zero > /dev/null

      - name: Cleanup
        if: always()
        run: sudo tailscale down || true
