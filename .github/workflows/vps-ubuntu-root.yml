name: VPS-Ubuntu-Root-24.04

on:
  workflow_dispatch:
    inputs:
      keep_alive:
        description: "minutes to keep alive (0 = forever)"
        required: false
        default: "60"

env:
  TZ: UTC

jobs:
  boot-and-root:
    runs-on: ubuntu-24.04
    steps:
      - name: Update system
        run: |
          sudo apt-get update -y
          sudo apt-get dist-upgrade -y

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
                           --hostname="gh-root-${{ github.run_id }}"

      - name: Create deploy user (no password)
        run: |
          sudo useradd -m -s /bin/bash deploy
          sudo usermod -aG sudo deploy
          echo "deploy ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/99-deploy

      - name: Add your SSH public key
        run: |
          sudo mkdir -p /home/deploy/.ssh
          echo "${{ secrets.VPS_PUBLIC_KEY }}" | sudo tee /home/deploy/.ssh/authorized_keys
          sudo chown -R deploy:deploy /home/deploy/.ssh
          sudo chmod 700 /home/deploy/.ssh
          sudo chmod 600 /home/deploy/.ssh/authorized_keys

      - name: Harden SSH (key-only)
        run: |
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          # إعادة تشغيل SSH بطريقة متوافقة مع بيئة Actions
          sudo service ssh restart || sudo systemctl reload ssh || true

      - name: Show Tailscale IP
        id: ts
        run: |
          IP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_OUTPUT
          echo "✅ VPS ready (sudo user: deploy). Tailscale IP: $IP"

      - name: Keep alive
        run: |
          if [[ "${{ inputs.keep_alive }}" == "0" ]]; then
            tail -f /dev/null
          else
            sleep $(( ${{ inputs.keep_alive }} * 60 ))
          fi

      - name: Cleanup
        if: always()
        run: sudo tailscale down || true
